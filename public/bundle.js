!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t){e.exports=require("bluebird")},function(e,t,n){e.exports=n(4)},function(e,t){e.exports=require("pg-promise")},function(e,t){e.exports=require("fastify")},function(e,t,n){"use strict";n.r(t);var r=n(0),o=n(2)({promiseLib:r})("postgres://docker:docker@localhost:5432/docker"),u=new(function(){function e(){}return e.prototype.insertInto=function(e){return o.none("INSERT INTO users (nickname, email, fullname, about) \n            VALUES ($1, $2, $3, $4)",[e.nickname,e.email,e.fullname,e.about]).then((function(){return!0})).catch((function(){return!1}))},e.prototype.getByNickname=function(e){return o.one("SELECT id, nickname, email, fullname, about FROM users \n            WHERE lower(nickname) = lower($1)",[e]).then((function(e){return e})).catch((function(){return null}))},e.prototype.getByEmail=function(e){return o.one("SELECT id, nickname, email, fullname, about FROM users \n            WHERE lower(email) = lower($1)",[e]).then((function(e){return e})).catch((function(){return null}))},e.prototype.updateUser=function(e){return o.none("UPDATE users SET email = $2, fullname = $3, about = $4  \n            WHERE lower(nickname) = lower($1)",[e.nickname,e.email,e.fullname,e.about]).then((function(){return!0})).catch((function(){return!1}))},e.prototype.getUsersByForum=function(e,t,n,r){var u="SELECT u.nickname, u.email, u.fullname, u.about FROM forums_users fu \n            JOIN users u ON (fu.user_id = u.id) WHERE fu.forum_id = $1",s=" ORDER BY lower(u.nickname)";r&&(s+=" DESC"),0!==t&&(s+=" LIMIT "+t);var a=[];return a.push(e),void 0!==n&&""!==n&&(u+=r?" AND lower(u.nickname) < lower($2)":" AND lower(u.nickname) > lower($2)",a.push(n)),o.manyOrNone(u+s,a).then((function(e){return e})).catch((function(){return null}))},e.prototype.checkNicknames=function(e){return o.many("SELECT id, lower(nickname) AS nickname FROM users").then((function(t){for(var n={},r=0,o=t;r<o.length;r++){var u=o[r];n[u.nickname]=u.id}for(var s=0,a=e;s<a.length;s++){var i=n[(f=a[s]).author.toLowerCase()];if(0===i)return e;f.authorId=i}for(var c=0,l=e;c<l.length;c++){var f;if(void 0===(f=l[c]).authorId)return null}return e})).catch((function(){return null}))},e}()),s=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},a=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},i=new(function(){function e(){}return e.prototype.addUser=function(e,t){return s(this,void 0,void 0,(function(){var n,r,o;return a(this,(function(s){switch(s.label){case 0:return[4,u.getByNickname(e)];case 1:return n=s.sent(),[4,u.getByEmail(t.email)];case 2:return r=s.sent(),null!==n||null!==r?(o=[],null!==n?(o.push(n),null!==r&&r.nickname!==n.nickname&&o.push(r)):null!==r&&o.push(r),[2,o]):(t.nickname=e,[4,u.insertInto(t)]);case 3:return s.sent()?[2,t]:[2,null]}}))}))},e.prototype.getByNickname=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return[4,u.getByNickname(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.updateUser=function(e,t){return s(this,void 0,void 0,(function(){var n,r;return a(this,(function(o){switch(o.label){case 0:return[4,u.getByNickname(e)];case 1:return n=o.sent(),[4,u.getByEmail(t.email)];case 2:if(r=o.sent(),null===n)return[2,null];if(null!==r&&t.nickname!==r.nickname)throw new Error("User already exists");return t.nickname=e,void 0!==t.email&&""!==t.email||(t.email=n.email),void 0!==t.fullname&&""!==t.fullname||(t.fullname=n.fullname),void 0!==t.about&&""!==t.about||(t.about=n.about),[4,u.updateUser(t)];case 3:if(!o.sent())throw new Error("");return[2,t]}}))}))},e}()),c=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},l=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},f=new(function(){function e(){}return e.prototype.createUser=function(e,t){return c(this,void 0,void 0,(function(){var n,r,o;return l(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,3]),n=e.params.nickname,r=e.body,[4,i.addUser(n,r)];case 1:return null===(o=u.sent())&&t.code(500).send({message:"Bad Request"}),Array.isArray(o)?t.code(409).send(JSON.stringify(o)):t.code(201).send(o),[3,3];case 2:return u.sent(),[3,3];case 3:return[2]}}))}))},e.prototype.updateUser=function(e,t){return c(this,void 0,void 0,(function(){var n,r,o;return l(this,(function(u){switch(u.label){case 0:n=e.params.nickname,r=e.body,u.label=1;case 1:return u.trys.push([1,3,,4]),[4,i.updateUser(n,r)];case 2:return null===(o=u.sent())?t.code(404).send({message:"User doesn't exist"}):t.code(200).send(o),[3,4];case 3:return""===u.sent().message?t.code(500).send({message:"Bad Request"}):t.code(409).send({message:"Data Conflict"}),[3,4];case 4:return[2]}}))}))},e.prototype.getUser=function(e,t){return c(this,void 0,void 0,(function(){var n,r;return l(this,(function(o){switch(o.label){case 0:return n=e.params.nickname,[4,i.getByNickname(n)];case 1:return null===(r=o.sent())?t.code(404).send({message:"User doesn'n exist"}):t.code(200).send(r),[2]}}))}))},e}()),d=new(function(){function e(){}return e.prototype.insertInto=function(e){return o.none("INSERT INTO forums (slug, admin, title) VALUES ($1, $2, $3)",[e.slug,e.adminId,e.title]).then((function(){return!0})).catch((function(){return!1}))},e.prototype.getBySlug=function(e){return o.one("SELECT f.id, f.slug, u.nickname, f.title, f.threads, f.posts \n            FROM forums as f \n            JOIN users as u ON (u.id = f.admin) \n            WHERE lower(slug) = lower($1)",[e]).then((function(e){return e.user=e.nickname,e})).catch((function(){return null}))},e}()),h=new(function(){function e(){}return e.prototype.getCountByForumId=function(e){return o.one("SELECT count(*) AS count FROM threads WHERE forum = $1",[e]).then((function(e){return e})).catch((function(){return-1}))},e.prototype.insertInto=function(e){return void 0===e.created?o.one("INSERT INTO threads (slug, author, title, message, forum) \n            VALUES (NULLIF ($1, ''), $2, $3, $4, $5) RETURNING id",[e.slug,e.authorId,e.title,e.message,e.forumId]).then((function(t){return e.id=t.id,e})).catch((function(e){return null})):o.one("INSERT INTO threads (slug, author, title, message, forum, created) \n            VALUES (NULLIF ($1, ''), $2, $3, $4, $5, $6) RETURNING id",[e.slug,e.authorId,e.title,e.message,e.forumId,e.created]).then((function(t){return e.id=t.id,e})).catch((function(e){return null}))},e.prototype.getBySlug=function(e){return o.one("SELECT t.id, u.nickname, t.created, t.forum, f.slug, t.message, \n            coalesce (t.slug, ''), t.title, t.votes FROM threads AS t \n            JOIN users AS u ON (t.author = u.id) \n            JOIN forums AS f ON (f.id = t.forum) WHERE lower(t.slug) = lower($1)",[e]).then((function(e){return e})).catch((function(){return null}))},e.prototype.getById=function(e){return o.one("SELECT t.id, u.nickname, t.created, t.forum, f.slug, t.message, \n            coalesce (t.slug, ''), t.title, t.votes FROM threads AS t \n            JOIN users AS u ON (t.author = u.id) \n            JOIN forums AS f ON (f.id = t.forum) WHERE t.id = $1",[e]).then((function(e){return e})).catch((function(){return null}))},e.prototype.updateThread=function(e){return o.none("UPDATE threads SET message = $2, title = $3 WHERE id = $1",[e.id,e.message,e.title]).then((function(){return e})).catch((function(e){return null}))},e.prototype.getByForumSlug=function(e,t,n,r){var u="SELECT t.id, u.nickname AS author, t.created, f.slug AS forum, t.message, \n            coalesce (t.slug, ''), t.title, t.votes, t.slug FROM threads AS t \n            JOIN users AS u ON (t.author = u.id) \n            JOIN forums AS f ON (f.id = t.forum) WHERE lower(f.slug) = lower($1)",s=" ORDER BY t.created";r&&(s+=" DESC"),0!==t&&(s+=" LIMIT "+t);var a=[];return a.push(e),void 0!==n&&""!==n&&(u+=r?" AND t.created <= $2":" AND t.created >= $2",a.push(n)),o.manyOrNone(u+s,a).then((function(e){return e})).catch((function(e){return null}))},e}()),p=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},y=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},m=new(function(){function e(){}return e.prototype.addForum=function(e){return p(this,void 0,void 0,(function(){var t,n;return y(this,(function(r){switch(r.label){case 0:return[4,d.getBySlug(e.slug)];case 1:return t=r.sent(),[4,u.getByNickname(e.user)];case 2:if(null===(n=r.sent()))throw new Error("User does not exist");return null!==t?(t.user=n.nickname,[2,Promise.reject(t)]):(e.user=n.nickname,e.adminId=n.id,[4,d.insertInto(e)]);case 3:return r.sent()?[2,e]:[2,null]}}))}))},e.prototype.getForumBySlug=function(e){return p(this,void 0,void 0,(function(){var t;return y(this,(function(n){switch(n.label){case 0:return[4,d.getBySlug(e)];case 1:if(null===(t=n.sent()))throw new Error("Forum does not exist");return[2,t]}}))}))},e.prototype.getForumThreads=function(e,t,n,r){return p(this,void 0,void 0,(function(){return y(this,(function(o){switch(o.label){case 0:return[4,d.getBySlug(e)];case 1:if(null===o.sent())throw new Error("Forum does not exist");return[4,h.getByForumSlug(e,t,n,r)];case 2:return[2,o.sent()]}}))}))},e.prototype.getForumUsers=function(e,t,n,r){return p(this,void 0,void 0,(function(){var o;return y(this,(function(s){switch(s.label){case 0:return[4,d.getBySlug(e)];case 1:if(null===(o=s.sent()))throw new Error("Forum does not exist");return[4,u.getUsersByForum(o.id,t,n,r)];case 2:return[2,s.sent()]}}))}))},e}()),g=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},b=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},v=new(function(){function e(){}return e.prototype.insertInto=function(e){return g(this,void 0,void 0,(function(){var t,n,r,u,s,a,i,c,l,f,d,h,p,y;return b(this,(function(m){switch(m.label){case 0:for(t="INSERT INTO posts (author, forum, message, parent, thread, created) VALUES ",n=[],r=1,u="INSERT INTO forums_users (user_id, forum_id) VALUES ",s=[],a=1,i=new Date(Date.now()).toISOString(),c=0,l=e;c<l.length;c++)f=l[c],t+="($"+r+", $"+(r+1)+", $"+(r+2)+", $"+(r+3)+", $"+(r+4)+", $"+(r+5)+"),",r+=6,n.push(f.authorId,f.forumId,f.message,f.parentId,f.threadId,i),u+="($"+a+", $"+(a+1)+"),",a+=3,s.push(f.authorId,f.forumId);m.label=1;case 1:return m.trys.push([1,3,,4]),t=t.slice(0,-1),[4,o.many(t+" RETURNING id",n)];case 2:for(d=m.sent(),console.log("AUTHOR_ID:",d),h=0;h<d.length;h++)e[h].id=d[h].id,e[h].created=i,e[h].thread=e[h].threadId;return[3,4];case 3:return p=m.sent(),console.log(t+" RETURNING id"),console.log(n),console.log(p),[3,4];case 4:u=u.slice(0,-1),u+=" ON CONFLICT DO NOTHING",m.label=5;case 5:return m.trys.push([5,7,,8]),[4,o.none(u,s)];case 6:return m.sent(),[3,8];case 7:return y=m.sent(),console.log(u),console.log(r),console.log(y),[3,8];case 8:return[2,e]}}))}))},e.prototype.getCountByForumId=function(e){return g(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,o.one("SELECT count(*) AS count from posts WHERE forum = $1",[e]).then((function(e){return e})).catch((function(){return-1}))];case 1:return[2,t.sent()]}}))}))},e.prototype.getById=function(e){return g(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,o.one("SELECT p.id, u.nickname AS author, f.slug AS forum, p.thread, p.message, p.created, p.isEdited, \n            coalesce(path[array_length(path, 1) - 1], 0) FROM posts AS p \n            JOIN users AS u ON (u.id = p.author) \n            JOIN forums AS f ON (f.id = p.forum) WHERE p.id = $1",[e]).then((function(e){return e})).catch((function(e){return null}))];case 1:return[2,t.sent()]}}))}))},e.prototype.updatePost=function(e){return g(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,o.none("UPDATE posts SET message = $2, isEdited = TRUE \n            WHERE id = $1",[e.id,e.message]).then((function(){return e.isEdited=!0,e})).catch((function(e){return null}))];case 1:return[2,t.sent()]}}))}))},e.prototype.getByThread=function(e,t,n,r,u){return g(this,void 0,void 0,(function(){var s,a,i;return b(this,(function(c){switch(c.label){case 0:switch(void 0===r&&(r="flat"),s="SELECT p.id, u.nickname AS author, f.slug AS forum, p.parent, p.thread, p.created, p.message, p.isEdited, \n            coalesce(p.path[array_length(p.path, 1) - 1], 0) FROM posts AS p \n            JOIN users AS u ON (u.id = p.author) \n            JOIN forums AS f ON (f.id = p.forum) \n            WHERE ",void 0===n&&(n=0),r){case"flat":case"":a="p.thread = $1",0!==n&&(a+=u?" AND p.id < $2":" AND p.id > $2"),i="ORDER BY ","flat"===r?(i+="p.created",u&&(i+=" DESC"),i+=", p.id",u&&(i+=" DESC")):(i+="p.id",u&&(i+=" DESC")),0!==t&&(i+=0!==n?" LIMIT $3":" LIMIT $2");break;case"tree":a="p.thread = $1",0!==n&&(a+=u?" AND coalesce(path < (select path FROM posts where id = $2), true)":" AND coalesce(path > (select path FROM posts where id = $2), true)"),i="ORDER BY p.path[1]",u&&(i+=" DESC"),i+=", p.path[2:]",u&&(i+=" DESC"),i+=" NULLS FIRST",0!==t&&(i+=0!==n?" LIMIT $3":" LIMIT $2");break;case"parent_tree":a="p.path[1] IN (SELECT path[1] FROM posts WHERE thread = $1 AND array_length(path, 1) = 1",0!==n&&(a+=u?" AND id < (SELECT path[1] FROM posts WHERE id = $2)":" AND id > (SELECT path[1] FROM posts WHERE id = $2)"),a+=" ORDER BY id",u&&(a+=" DESC"),0!==t&&(a+=0!==n?" LIMIT $3":" LIMIT $2"),a+=")",i="ORDER BY p.path[1]",u&&(i+=" DESC"),i+=", p.path[2:] NULLS FIRST"}return 0===n?[3,5]:0===t?[3,2]:[4,o.manyOrNone(s+a+" "+i,[e,n,t]).then((function(e){return e})).catch((function(e){return null}))];case 1:return[2,c.sent()];case 2:return[4,o.manyOrNone(s+a+" "+i,[e,n]).then((function(e){return e})).catch((function(e){return null}))];case 3:return[2,c.sent()];case 4:return[3,9];case 5:return 0===t?[3,7]:[4,o.manyOrNone(s+a+" "+i,[e,t]).then((function(e){return e})).catch((function(e){return null}))];case 6:return[2,c.sent()];case 7:return[4,o.manyOrNone(s+a+" "+i,[e]).then((function(e){return e})).catch((function(e){return null}))];case 8:return[2,c.sent()];case 9:return[2]}}))}))},e.prototype.checkParentPosts=function(e,t){return g(this,void 0,void 0,(function(){var n,r,u,s,a;return b(this,(function(i){switch(i.label){case 0:for(n={},(r=[]).push(t),u="SELECT count(*) AS count FROM posts WHERE thread = $1 AND id in (",s=2,a=0;a<e.length;a++)e[a].parentId>0&&(u+="$"+s+",",void 0===n[e[a].parentId]?n[e[a].parentId]=1:n[e[a].parentId]+=1,r.push(e[a].parentId),s++);return 0===Object.keys(n).length?[2,!0]:(u=u.slice(0,u.length-1)+")",[4,o.one(u,r).then((function(e){return e.count==Object.keys(n).length})).catch((function(e){return!1}))]);case 1:return[2,i.sent()]}}))}))},e}()),w=new(function(){function e(){}return e.prototype.insertInto=function(e){return o.one("SELECT id FROM votes WHERE thread = $1 and author = $2",[e.threadId,e.userId]).then((function(t){return o.none("UPDATE votes SET vote = $2 WHERE id = $1",[t.id,e.voice]).then((function(){return e})).catch((function(e){return null}))})).catch((function(){return o.none("INSERT INTO votes (author, thread, vote) VALUES ($1, $2, $3)",[e.userId,e.threadId,e.voice]).then((function(){return e})).catch((function(e){return null}))}))},e.prototype.getThreadVotes=function(e){return o.one("SELECT votes FROM threads WHERE id = $1",[e]).then((function(e){return e.votes})).catch((function(e){return-1}))},e}()),E=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},S=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},T=new(function(){function e(){}return e.prototype.addThread=function(e){return E(this,void 0,void 0,(function(){var t,n,r;return S(this,(function(o){switch(o.label){case 0:return[4,d.getBySlug(e.forum)];case 1:if(null===(t=o.sent()))throw new Error("Forum does not exist");return[4,u.getByNickname(e.author)];case 2:if(null===(n=o.sent()))throw new Error("User does not exist");return[4,h.getBySlug(e.slug)];case 3:return null!==(r=o.sent())?(r.forum=r.slug,r.slug=r.coalesce,r.author=r.nickname,[2,Promise.reject(r)]):(e.forum=t.slug,e.author=n.nickname,e.authorId=n.id,e.forumId=t.id,[4,h.insertInto(e)]);case 4:return[2,o.sent()]}}))}))},e.prototype.createPosts=function(e,t){return E(this,void 0,void 0,(function(){var n,r,o,s,a,i,c;return S(this,(function(l){switch(l.label){case 0:return r=+e,isNaN(r)?[4,h.getBySlug(e)]:[3,2];case 1:return n=l.sent(),[3,4];case 2:return[4,h.getById(r)];case 3:n=l.sent(),l.label=4;case 4:if(null===n)throw new Error("Thread does not exist");return 0===t.length?[2,[]]:[4,u.checkNicknames(t)];case 5:if(null===(o=l.sent()))throw new Error("User does not exist");return t=o,[4,v.checkParentPosts(t,n.id)];case 6:if(!l.sent())throw new Error("Data Conflict");for(s=0,a=t;s<a.length;s++)(i=a[s]).threadId=n.id,i.forum=n.slug,i.forumId=+n.forum;l.label=7;case 7:return l.trys.push([7,9,,10]),[4,v.insertInto(t)];case 8:return null!==l.sent()?[2,t]:[2,null];case 9:return c=l.sent(),console.log(c),[3,10];case 10:return[2]}}))}))},e.prototype.getBySlugOrId=function(e){return E(this,void 0,void 0,(function(){var t,n;return S(this,(function(r){switch(r.label){case 0:return n=+e,isNaN(n)?[4,h.getBySlug(e)]:[3,2];case 1:return t=r.sent(),[3,4];case 2:return[4,h.getById(n)];case 3:t=r.sent(),r.label=4;case 4:return[2,t]}}))}))},e.prototype.updateThread=function(e,t){return E(this,void 0,void 0,(function(){var n,r,o;return S(this,(function(u){switch(u.label){case 0:return r=+e,isNaN(r)?[4,h.getBySlug(e)]:[3,2];case 1:return n=u.sent(),[3,4];case 2:return[4,h.getById(r)];case 3:n=u.sent(),u.label=4;case 4:if(null===n)throw Error("Thread does not exist");return void 0!==t.message&&""!=t.message&&(n.message=t.message),void 0!==t.title&&""!=t.title&&(n.title=t.title),[4,h.updateThread(n)];case 5:return null===u.sent()?[3,7]:(o=n,[4,w.getThreadVotes(n.id)]);case 6:if(o.votes=u.sent(),n.votes>-1)return n.forum=n.slug,n.slug=n.coalesce,n.author=n.nickname,[2,n];u.label=7;case 7:return[2,null]}}))}))},e.prototype.vote=function(e,t){return E(this,void 0,void 0,(function(){var n,r,o,s;return S(this,(function(a){switch(a.label){case 0:return r=+e,isNaN(r)?[4,h.getBySlug(e)]:[3,2];case 1:return n=a.sent(),[3,4];case 2:return[4,h.getById(r)];case 3:n=a.sent(),a.label=4;case 4:if(null===n)throw Error("Thread does not exist");return[4,u.getByNickname(t.nickname)];case 5:if(null===(o=a.sent()))throw Error("User does not exist");return t.threadId=n.id,t.userId=o.id,[4,w.insertInto(t)];case 6:return null===a.sent()?[3,8]:(s=n,[4,w.getThreadVotes(n.id)]);case 7:return s.votes=a.sent(),n.forum=n.slug,n.slug=n.coalesce,n.author=n.nickname,[2,n];case 8:return[2,null]}}))}))},e.prototype.getThreadPosts=function(e,t,n,r,o){return E(this,void 0,void 0,(function(){var u,s;return S(this,(function(a){switch(a.label){case 0:return s=+e,isNaN(s)?[4,h.getBySlug(e)]:[3,2];case 1:return u=a.sent(),[3,4];case 2:return[4,h.getById(s)];case 3:u=a.sent(),a.label=4;case 4:if(null===u)throw Error("Thread does not exist");return[4,v.getByThread(u.id,t,n,r,o)];case 5:return[2,a.sent()]}}))}))},e}()),k=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},x=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},I=new(function(){function e(){}return e.prototype.createForum=function(e,t){return k(this,void 0,void 0,(function(){var n,r,o;return x(this,(function(u){switch(u.label){case 0:n=e.body,u.label=1;case 1:return u.trys.push([1,3,,4]),[4,m.addForum(n)];case 2:return r=u.sent(),t.code(201).send(r),[3,4];case 3:switch((o=u.sent()).message){case"User does not exist":t.code(404).send({message:"User does not exist"});break;case"Forum does not exist":t.code(404).send({message:"Forum does not exist"});break;case"Data Conflict":t.code(409).send({message:"Data Conflict"})}return"slug"in o&&t.code(409).send(o),[3,4];case 4:return[2]}}))}))},e.prototype.createThead=function(e,t){return k(this,void 0,void 0,(function(){var n,r,o,u;return x(this,(function(s){switch(s.label){case 0:n=e.params.slug,(r=e.body).forum=n,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,T.addThread(r)];case 2:return o=s.sent(),t.code(201).send(o),[3,4];case 3:switch((u=s.sent()).message){case"User does not exist":t.code(404).send({message:"User does not exist"});break;case"Forum does not exist":t.code(404).send({message:"Forum does not exist"});break;case"Thread does not exist":t.code(404).send({message:"Thread does not exist"});break;case"Data Conflict":t.code(409).send({message:"Data Conflict"})}return void 0!==u.slug&&t.code(409).send(u),[3,4];case 4:return[2]}}))}))},e.prototype.getForumDatails=function(e,t){return k(this,void 0,void 0,(function(){var n,r;return x(this,(function(o){switch(o.label){case 0:n=e.params.slug,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,m.getForumBySlug(n)];case 2:return r=o.sent(),t.code(200).send(r),[3,4];case 3:switch(o.sent().message){case"Forum does not exist":t.code(404).send({message:"Forum does not exist"})}return[3,4];case 4:return[2]}}))}))},e.prototype.getForumThreads=function(e,t){return k(this,void 0,void 0,(function(){var n,r,o,u,s;return x(this,(function(a){switch(a.label){case 0:n=e.params.slug,r=e.query.limit,o=e.query.since,u="true"===e.query.desc,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,m.getForumThreads(n,r,o,u)];case 2:return s=a.sent(),t.code(200).send(s),[3,4];case 3:switch(a.sent().message){case"Forum does not exist":t.code(404).send({message:"Forum does not exist"})}return[3,4];case 4:return[2]}}))}))},e.prototype.getForumUsers=function(e,t){return k(this,void 0,void 0,(function(){var n,r,o,u,s;return x(this,(function(a){switch(a.label){case 0:n=e.params.slug,r=e.query.limit||100,o=e.query.since,u="true"===e.query.desc,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,m.getForumUsers(n,r,o,u)];case 2:return s=a.sent(),t.code(200).send(s),[3,4];case 3:switch(a.sent().message){case"Forum does not exist":t.code(404).send({message:"Forum does not exist"})}return[3,4];case 4:return[2]}}))}))},e}()),N=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},O=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},R=new(function(){function e(){}return e.prototype.createPost=function(e,t){return N(this,void 0,void 0,(function(){var n,r,o,u,s,a;return O(this,(function(i){switch(i.label){case 0:for(n=e.params.slug_or_id,r=e.body||[],o=0,u=r;o<u.length;o++)(s=u[o]).parentId=s.parent;i.label=1;case 1:return i.trys.push([1,3,,4]),[4,T.createPosts(n,r)];case 2:return a=i.sent(),t.code(201).send(a),[3,4];case 3:switch(i.sent().message){case"User does not exist":t.code(404).send({message:"User does not exist"});break;case"Thread does not exist":t.code(404).send({message:"Thread does not exist"});break;case"Data Conflict":t.code(409).send({message:"Data Conflict"});break;default:t.code(404).send({message:"Thread does not exist"})}return[3,4];case 4:return[2]}}))}))},e.prototype.updateThead=function(e,t){return N(this,void 0,void 0,(function(){var n,r,o;return O(this,(function(u){switch(u.label){case 0:n=e.params.slug_or_id,r=e.body,u.label=1;case 1:return u.trys.push([1,6,,7]),o=void 0,0===Object.keys(r).length?[3,3]:[4,T.updateThread(n,r)];case 2:return o=u.sent(),[3,5];case 3:return[4,T.getBySlugOrId(n)];case 4:(o=u.sent()).forum=o.slug,o.slug=o.coalesce,o.author=o.nickname,u.label=5;case 5:return t.code(200).send(o),[3,7];case 6:switch(u.sent().message){case"Thread does not exist":t.code(404).send({message:"Thread does not exist"})}return[3,7];case 7:return[2]}}))}))},e.prototype.getThreadDetails=function(e,t){return N(this,void 0,void 0,(function(){var n,r;return O(this,(function(o){switch(o.label){case 0:n=e.params.slug_or_id,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,T.getBySlugOrId(n)];case 2:return null===(r=o.sent())?t.code(404).send({message:"Thread does not exist"}):(r.forum=r.slug,r.slug=r.coalesce,r.author=r.nickname,t.code(200).send(r)),[3,4];case 3:switch(o.sent().message){case"Thread does not exist":t.code(404).send({message:"Thread does not exist"})}return[3,4];case 4:return[2]}}))}))},e.prototype.threadVote=function(e,t){return N(this,void 0,void 0,(function(){var n,r,o;return O(this,(function(u){switch(u.label){case 0:n=e.params.slug_or_id,r=e.body,u.label=1;case 1:return u.trys.push([1,3,,4]),[4,T.vote(n,r)];case 2:return o=u.sent(),t.code(200).send(o),[3,4];case 3:switch(u.sent().message){case"Thread does not exist":t.code(404).send({message:"Forum does not exist"});break;case"User does not exist":t.code(404).send({message:"User does not exist"})}return[3,4];case 4:return[2]}}))}))},e.prototype.getThreadPosts=function(e,t){return N(this,void 0,void 0,(function(){var n,r,o,u,s,a;return O(this,(function(i){switch(i.label){case 0:n=e.params.slug_or_id,r=e.query.limit,o=e.query.since,u="true"===e.query.desc,s=e.query.sort,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,T.getThreadPosts(n,r,o,s,u)];case 2:return a=i.sent(),t.code(200).send(a),[3,4];case 3:switch(i.sent().message){case"Thread does not exist":t.code(404).send({message:"Thread does not exist"})}return[3,4];case 4:return[2]}}))}))},e}()),A=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},$=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},C=new(function(){function e(){}return e.prototype.getPostDetails=function(e,t){return A(this,void 0,void 0,(function(){var n,r,o,s,a,i,c,l;return $(this,(function(f){switch(f.label){case 0:return n={},[4,v.getById(e)];case 1:if(null===(r=f.sent()))throw new Error("Post does not exist");r.isEdited=r.isedited,n.post=r,o=0,s=t,f.label=2;case 2:if(!(o<s.length))return[3,10];switch(a=s[o],a){case"user":return[3,3];case"forum":return[3,5];case"thread":return[3,7]}return[3,9];case 3:return[4,u.getByNickname(r.author)];case 4:if(null===(i=f.sent()))throw new Error("User does not exist");return n.author=i,[3,9];case 5:return[4,d.getBySlug(r.forum)];case 6:if(null===(c=f.sent()))throw new Error("Forum does not exist");return n.forum=c,[3,9];case 7:return[4,h.getById(r.thread)];case 8:if(null===(l=f.sent()))throw new Error("Thread does not exist");return l.forum=l.slug,l.slug=l.coalesce,l.author=l.nickname,n.thread=l,[3,9];case 9:return o++,[3,2];case 10:return[2,n]}}))}))},e.prototype.updatePost=function(e){return A(this,void 0,void 0,(function(){var t;return $(this,(function(n){switch(n.label){case 0:return[4,v.getById(e.id)];case 1:if(null===(t=n.sent()))throw new Error("Post does not exist");return""==e.message||e.message===t.message?[2,t]:(t.message=e.message,t.edited=!0,[4,v.updatePost(t)]);case 2:return[2,n.sent()]}}))}))},e}()),B=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},F=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},U=new(function(){function e(){}return e.prototype.updatePost=function(e,t){return B(this,void 0,void 0,(function(){var n,r,o,u;return F(this,(function(s){switch(s.label){case 0:n=e.params.id,r=e.body,s.label=1;case 1:return s.trys.push([1,6,,7]),o=void 0,0===Object.keys(r).length?[3,3]:(r.id=n,[4,C.updatePost(r)]);case 2:return o=s.sent(),[3,5];case 3:return[4,C.getPostDetails(n,[])];case 4:u=s.sent(),o=u.post,s.label=5;case 5:return t.code(200).send(o),[3,7];case 6:return"Post does not exist"===s.sent().message?t.code(404).send({message:"Post does not exist"}):t.code(500).send({message:"Bad Request"}),[3,7];case 7:return[2]}}))}))},e.prototype.getPostDetails=function(e,t){return B(this,void 0,void 0,(function(){var n,r,o,u;return F(this,(function(s){switch(s.label){case 0:n=e.params.id,r=e.query.related,o=void 0===r?[]:r.split(","),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,C.getPostDetails(n,o)];case 2:return u=s.sent(),t.code(200).send(u),[3,4];case 3:return"Post does not exist"===s.sent().message?t.code(404).send({message:"Post does not exist"}):t.code(500).send({message:"Bad Request"}),[3,4];case 4:return[2]}}))}))},e}()),D=new(function(){function e(){}return e.prototype.getCountForum=function(){return o.one("SELECT count(*) AS count from forums").then((function(e){return e.count})).catch((function(){return-1}))},e.prototype.getCountPost=function(){return o.one("SELECT count(*) AS count from posts").then((function(e){return e.count})).catch((function(){return-1}))},e.prototype.getCountThread=function(){return o.one("SELECT count(*) AS count from threads").then((function(e){return e.count})).catch((function(){return-1}))},e.prototype.getCountUser=function(){return o.one("SELECT count(*) AS count from users").then((function(e){return e.count})).catch((function(){return-1}))},e.prototype.deleteForums=function(){return o.none("TRUNCATE TABLE forums CASCADE").then((function(){return 1})).catch((function(){return 0}))},e.prototype.deletePosts=function(){return o.none("TRUNCATE TABLE posts CASCADE").then((function(){return 1})).catch((function(){return 0}))},e.prototype.deleteThreads=function(){return o.none("TRUNCATE TABLE threads CASCADE").then((function(){return 1})).catch((function(){return 0}))},e.prototype.deleteUsers=function(){return o.none("TRUNCATE TABLE users CASCADE").then((function(){return 1})).catch((function(){return 0}))},e.prototype.deleteVotes=function(){return o.none("TRUNCATE TABLE votes CASCADE").then((function(){return 1})).catch((function(){return 0}))},e}()),P=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},L=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},_=new(function(){function e(){}return e.prototype.getStatus=function(){return P(this,void 0,void 0,(function(){var e,t,n,r,o,u;return L(this,(function(s){switch(s.label){case 0:return t=e={},[4,D.getCountForum()];case 1:return t.forum=s.sent(),n=e,[4,D.getCountPost()];case 2:return n.post=s.sent(),r=e,[4,D.getCountThread()];case 3:return r.thread=s.sent(),o=e,[4,D.getCountUser()];case 4:for(u in o.user=s.sent(),e)if(e[u]=+e[u],e[u]<0)return[2,null];return[2,e]}}))}))},e.prototype.deleteAll=function(){return P(this,void 0,void 0,(function(){var e,t,n,r,o,u;return L(this,(function(s){switch(s.label){case 0:return t=e=0,[4,D.deleteVotes()];case 1:return e=t+s.sent(),n=e,[4,D.deletePosts()];case 2:return e=n+s.sent(),r=e,[4,D.deleteThreads()];case 3:return e=r+s.sent(),o=e,[4,D.deleteForums()];case 4:return e=o+s.sent(),u=e,[4,D.deleteUsers()];case 5:return[2,5===(e=u+s.sent())]}}))}))},e}()),M=function(e,t,n,r){return new(n||(n=Promise))((function(o,u){function s(e){try{i(r.next(e))}catch(e){u(e)}}function a(e){try{i(r.throw(e))}catch(e){u(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}i((r=r.apply(e,t||[])).next())}))},H=function(e,t){var n,r,o,u,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}},W=new(function(){function e(){}return e.prototype.getStatus=function(e,t){return M(this,void 0,void 0,(function(){var e;return H(this,(function(n){switch(n.label){case 0:return[4,_.getStatus()];case 1:return e=n.sent(),console.log(e),null===e?t.code(400).send({message:"Bad Request"}):t.code(200).send(e),[2]}}))}))},e.prototype.clear=function(e,t){return M(this,void 0,void 0,(function(){return H(this,(function(e){switch(e.label){case 0:return[4,_.deleteAll()];case 1:return e.sent()?t.code(200).send(""):t.code(400).send({message:"Bad Request"}),[2]}}))}))},e}()),q=n(3)({});q.addContentTypeParser("application/json",{parseAs:"buffer"},(function(e,t,n){t.length>0?n(null,JSON.parse(t)):n(null,{})})),q.listen(5e3,"0.0.0.0",(function(){console.log("Started on port 5000")})),q.post("/api/user/:nickname/create",f.createUser),q.get("/api/user/:nickname/profile",f.getUser),q.post("/api/user/:nickname/profile",f.updateUser),q.post("/api/forum/create",I.createForum),q.get("/api/forum/:slug/details",I.getForumDatails),q.post("/api/forum/:slug/create",I.createThead),q.get("/api/forum/:slug/threads",I.getForumThreads),q.get("/api/forum/:slug/users",I.getForumUsers),q.post("/api/thread/:slug_or_id/create",R.createPost),q.post("/api/thread/:slug_or_id/vote",R.threadVote),q.get("/api/thread/:slug_or_id/details",R.getThreadDetails),q.get("/api/thread/:slug_or_id/posts",R.getThreadPosts),q.post("/api/thread/:slug_or_id/details",R.updateThead),q.get("/api/post/:id/details",U.getPostDetails),q.post("/api/post/:id/details",U.updatePost),q.get("/api/service/status",W.getStatus),q.post("/api/service/clear",W.clear)}]);